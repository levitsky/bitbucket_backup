{"links": {"self": {"href": "data/repositories/levitsky/pyteomics/issues/16/comments/33605639.json"}, "html": {"href": "#!/levitsky/pyteomics/issues/16#comment-33605639"}}, "issue": {"links": {"self": {"href": "data/repositories/levitsky/pyteomics/issues/16.json"}}, "type": "issue", "id": 16, "repository": {"links": {"self": {"href": "data/repositories/levitsky/pyteomics.json"}, "html": {"href": "#!/levitsky/pyteomics"}, "avatar": {"href": "data/bytebucket.org/ravatar/{3f6302de-10da-4d3c-b258-0bb6a2368972}ts=74456"}}, "type": "repository", "name": "pyteomics", "full_name": "levitsky/pyteomics", "uuid": "{3f6302de-10da-4d3c-b258-0bb6a2368972}"}, "title": "Checking of string inclusivity in _get_info-related dictionaries of formats using base64 encoded data is dangerous"}, "content": {"raw": "On the other hand, we could just try to handle the exception since it is less computationally expensive than `isinstance` call, but it would make the logic a little more complicated to trace. Here's that approach:\n\n```python\nif 'binary' in info:\n            # Prepare for the unlikely scenario that this test\n            # is performed on a byte string in Python2\n            try:\n                types = {'32-bit float': 'f', '64-bit float': 'd'}\n                for t, code in types.items():\n                    if t in info:\n                        dtype = code\n                        del info[t]\n                        break\n                # sometimes it's under 'name'\n                else:\n                    if 'name' in info:\n                        for t, code in types.items():\n                            if t in info['name']:\n                                dtype = code\n                                info['name'].remove(t)\n                                break\n                compressed = True\n                if 'zlib compression' in info:\n                    del info['zlib compression']\n                elif 'name' in info and 'zlib compression' in info['name']:\n                    info['name'].remove('zlib compression')\n                else:\n                    compressed = False\n                    info.pop('no compression', None)\n                    try:\n                        info['name'].remove('no compression')\n                        if not info['name']: del info['name']\n                    except (KeyError, TypeError):\n                        pass\n                b = info.pop('binary')\n                if b:\n                    array = aux._decode_base64_data_array(b, dtype, compressed)\n                else:\n                    array = np.array([], dtype=dtype)\n                for k in info:\n                    if k.endswith(' array') and not info[k]:\n                        info = {k: self._convert_array(k, array)}\n                        break\n                else:\n                    found = False\n                    # workaround for #!/levitsky/pyteomics/issues/11\n                    if isinstance(info.get('name'), list):\n                        knames = info['name']\n                        for val in knames:\n                            if val.endswith(' array'):\n                                info = {val: self._convert_array(val, array)}\n                                found = True\n                                break\n                    # last fallback\n                    if not found:\n                        info['binary'] = self._convert_array(None, array)\n            except AttributeError:\n                if isinstance(info, dict):\n                    raise\n                else:\n                    pass\n```", "markup": "markdown", "html": "<p>On the other hand, we could just try to handle the exception since it is less computationally expensive than <code>isinstance</code> call, but it would make the logic a little more complicated to trace. Here's that approach:</p>\n<div class=\"codehilite language-python\"><pre><span></span><span class=\"k\">if</span> <span class=\"s1\">&#39;binary&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">:</span>\n            <span class=\"c1\"># Prepare for the unlikely scenario that this test</span>\n            <span class=\"c1\"># is performed on a byte string in Python2</span>\n            <span class=\"k\">try</span><span class=\"p\">:</span>\n                <span class=\"n\">types</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"s1\">&#39;32-bit float&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;f&#39;</span><span class=\"p\">,</span> <span class=\"s1\">&#39;64-bit float&#39;</span><span class=\"p\">:</span> <span class=\"s1\">&#39;d&#39;</span><span class=\"p\">}</span>\n                <span class=\"k\">for</span> <span class=\"n\">t</span><span class=\"p\">,</span> <span class=\"n\">code</span> <span class=\"ow\">in</span> <span class=\"n\">types</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n                    <span class=\"k\">if</span> <span class=\"n\">t</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">:</span>\n                        <span class=\"n\">dtype</span> <span class=\"o\">=</span> <span class=\"n\">code</span>\n                        <span class=\"k\">del</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"n\">t</span><span class=\"p\">]</span>\n                        <span class=\"k\">break</span>\n                <span class=\"c1\"># sometimes it&#39;s under &#39;name&#39;</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"s1\">&#39;name&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">:</span>\n                        <span class=\"k\">for</span> <span class=\"n\">t</span><span class=\"p\">,</span> <span class=\"n\">code</span> <span class=\"ow\">in</span> <span class=\"n\">types</span><span class=\"o\">.</span><span class=\"n\">items</span><span class=\"p\">():</span>\n                            <span class=\"k\">if</span> <span class=\"n\">t</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]:</span>\n                                <span class=\"n\">dtype</span> <span class=\"o\">=</span> <span class=\"n\">code</span>\n                                <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"n\">t</span><span class=\"p\">)</span>\n                                <span class=\"k\">break</span>\n                <span class=\"n\">compressed</span> <span class=\"o\">=</span> <span class=\"bp\">True</span>\n                <span class=\"k\">if</span> <span class=\"s1\">&#39;zlib compression&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">:</span>\n                    <span class=\"k\">del</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;zlib compression&#39;</span><span class=\"p\">]</span>\n                <span class=\"k\">elif</span> <span class=\"s1\">&#39;name&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">info</span> <span class=\"ow\">and</span> <span class=\"s1\">&#39;zlib compression&#39;</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]:</span>\n                    <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"s1\">&#39;zlib compression&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">compressed</span> <span class=\"o\">=</span> <span class=\"bp\">False</span>\n                    <span class=\"n\">info</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"s1\">&#39;no compression&#39;</span><span class=\"p\">,</span> <span class=\"bp\">None</span><span class=\"p\">)</span>\n                    <span class=\"k\">try</span><span class=\"p\">:</span>\n                        <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span><span class=\"o\">.</span><span class=\"n\">remove</span><span class=\"p\">(</span><span class=\"s1\">&#39;no compression&#39;</span><span class=\"p\">)</span>\n                        <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]:</span> <span class=\"k\">del</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n                    <span class=\"k\">except</span> <span class=\"p\">(</span><span class=\"ne\">KeyError</span><span class=\"p\">,</span> <span class=\"ne\">TypeError</span><span class=\"p\">):</span>\n                        <span class=\"k\">pass</span>\n                <span class=\"n\">b</span> <span class=\"o\">=</span> <span class=\"n\">info</span><span class=\"o\">.</span><span class=\"n\">pop</span><span class=\"p\">(</span><span class=\"s1\">&#39;binary&#39;</span><span class=\"p\">)</span>\n                <span class=\"k\">if</span> <span class=\"n\">b</span><span class=\"p\">:</span>\n                    <span class=\"n\">array</span> <span class=\"o\">=</span> <span class=\"n\">aux</span><span class=\"o\">.</span><span class=\"n\">_decode_base64_data_array</span><span class=\"p\">(</span><span class=\"n\">b</span><span class=\"p\">,</span> <span class=\"n\">dtype</span><span class=\"p\">,</span> <span class=\"n\">compressed</span><span class=\"p\">)</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">array</span> <span class=\"o\">=</span> <span class=\"n\">np</span><span class=\"o\">.</span><span class=\"n\">array</span><span class=\"p\">([],</span> <span class=\"n\">dtype</span><span class=\"o\">=</span><span class=\"n\">dtype</span><span class=\"p\">)</span>\n                <span class=\"k\">for</span> <span class=\"n\">k</span> <span class=\"ow\">in</span> <span class=\"n\">info</span><span class=\"p\">:</span>\n                    <span class=\"k\">if</span> <span class=\"n\">k</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s1\">&#39; array&#39;</span><span class=\"p\">)</span> <span class=\"ow\">and</span> <span class=\"ow\">not</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"n\">k</span><span class=\"p\">]:</span>\n                        <span class=\"n\">info</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">k</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_convert_array</span><span class=\"p\">(</span><span class=\"n\">k</span><span class=\"p\">,</span> <span class=\"n\">array</span><span class=\"p\">)}</span>\n                        <span class=\"k\">break</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"n\">found</span> <span class=\"o\">=</span> <span class=\"bp\">False</span>\n                    <span class=\"c1\"># workaround for #!/levitsky/pyteomics/issues/11</span>\n                    <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">info</span><span class=\"o\">.</span><span class=\"n\">get</span><span class=\"p\">(</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">),</span> <span class=\"nb\">list</span><span class=\"p\">):</span>\n                        <span class=\"n\">knames</span> <span class=\"o\">=</span> <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;name&#39;</span><span class=\"p\">]</span>\n                        <span class=\"k\">for</span> <span class=\"n\">val</span> <span class=\"ow\">in</span> <span class=\"n\">knames</span><span class=\"p\">:</span>\n                            <span class=\"k\">if</span> <span class=\"n\">val</span><span class=\"o\">.</span><span class=\"n\">endswith</span><span class=\"p\">(</span><span class=\"s1\">&#39; array&#39;</span><span class=\"p\">):</span>\n                                <span class=\"n\">info</span> <span class=\"o\">=</span> <span class=\"p\">{</span><span class=\"n\">val</span><span class=\"p\">:</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_convert_array</span><span class=\"p\">(</span><span class=\"n\">val</span><span class=\"p\">,</span> <span class=\"n\">array</span><span class=\"p\">)}</span>\n                                <span class=\"n\">found</span> <span class=\"o\">=</span> <span class=\"bp\">True</span>\n                                <span class=\"k\">break</span>\n                    <span class=\"c1\"># last fallback</span>\n                    <span class=\"k\">if</span> <span class=\"ow\">not</span> <span class=\"n\">found</span><span class=\"p\">:</span>\n                        <span class=\"n\">info</span><span class=\"p\">[</span><span class=\"s1\">&#39;binary&#39;</span><span class=\"p\">]</span> <span class=\"o\">=</span> <span class=\"bp\">self</span><span class=\"o\">.</span><span class=\"n\">_convert_array</span><span class=\"p\">(</span><span class=\"bp\">None</span><span class=\"p\">,</span> <span class=\"n\">array</span><span class=\"p\">)</span>\n            <span class=\"k\">except</span> <span class=\"ne\">AttributeError</span><span class=\"p\">:</span>\n                <span class=\"k\">if</span> <span class=\"nb\">isinstance</span><span class=\"p\">(</span><span class=\"n\">info</span><span class=\"p\">,</span> <span class=\"nb\">dict</span><span class=\"p\">):</span>\n                    <span class=\"k\">raise</span>\n                <span class=\"k\">else</span><span class=\"p\">:</span>\n                    <span class=\"k\">pass</span>\n</pre></div>", "type": "rendered"}, "created_on": "2017-01-12T17:11:28.684874+00:00", "user": {"display_name": "Joshua Klein", "uuid": "{919f0add-304d-4b9a-8889-d2622a3dbc96}", "links": {"self": {"href": "https://api.bitbucket.org/2.0/users/%7B919f0add-304d-4b9a-8889-d2622a3dbc96%7D"}, "html": {"href": "https://bitbucket.org/%7B919f0add-304d-4b9a-8889-d2622a3dbc96%7D/"}, "avatar": {"href": "data/secure.gravatar.com/avatar/7d0e70bc74f783efa621a2bdd228ca22d=httpsavatar-management--avatars.us-west-2.prod.public.atl-paas.netinitialsJK-3.png"}}, "nickname": "mobiusklein", "type": "user", "account_id": "557058:ff82222f-afe5-4135-a1b7-8de99a00f669"}, "updated_on": null, "type": "issue_comment", "id": 33605639}